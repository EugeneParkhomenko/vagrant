# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|
   config.vm.box = "bertvv/centos72"
   config.vm.provider "virtualbox" do |vb|
    vb.gui = true
    vb.memory = "512"
   end
   
   config.vm.define "tomcat1" do |tomcat1|
	tomcat1.vm.hostname = "tomcat1"
	tomcat1.vm.network "private_network", 
	ip: "172.28.128.4", netmask: "255.255.255.0"
    tomcat1.vm.provision "shell", inline: <<-SHELL
	systemctl stop firewalld.service
	yum install tomcat tomcat-webapps tomcat-admin-webapps -y
	mkdir /usr/share/tomcat/webapps/test
	echo "Tomcat server 1" > /usr/share/tomcat/webapps/test/index.html
	systemctl enable tomcat
	systemctl start tomcat
	SHELL
   end

   config.vm.define "tomcat2" do |tomcat2|
	tomcat2.vm.hostname = "tomcat2"
	tomcat2.vm.network "private_network", 
	ip: "172.28.128.5", netmask: "255.255.255.0" 
    tomcat2.vm.provision "shell", inline: <<-SHELL
	systemctl stop firewalld.service
	yum install tomcat tomcat-webapps tomcat-admin-webapps -y
	mkdir /usr/share/tomcat/webapps/test
	echo "Tomcat server 2" > /usr/share/tomcat/webapps/test/index.html
	systemctl enable tomcat
	systemctl start tomcat
	SHELL
   end

   config.vm.define "apache" do |apache|
	apache.vm.hostname = "apache"
	apache.vm.network "private_network", ip: "172.28.128.6", netmask: "255.255.255.0"
    apache.vm.network "forwarded_port", guest: 80, host: 8080
	apache.vm.provision "shell", inline: <<-SHELL
	yum install httpd -y
	cp /vagrant/mod_jk.so /etc/httpd/modules/
	touch /etc/httpd/conf/workers.properties
	echo "worker.list=lb" >> /etc/httpd/conf/workers.properties
	echo "worker.lb.type=lb" >> /etc/httpd/conf/workers.properties
	echo "worker.lb.balance_workers=tomcat1, tomcat2" >> /etc/httpd/conf/workers.properties
	echo "worker.tomcat1.host=172.28.128.4" >> /etc/httpd/conf/workers.properties
	echo "worker.tomcat1.port=8009" >> /etc/httpd/conf/workers.properties
	echo "worker.tomcat1.type=ajp13" >> /etc/httpd/conf/workers.properties
	echo "worker.tomcat2.host=172.28.128.5" >> /etc/httpd/conf/workers.properties
	echo "worker.tomcat2.port=8009" >> /etc/httpd/conf/workers.properties
	echo "worker.tomcat2.type=ajp13" >> /etc/httpd/conf/workers.properties
	echo "LoadModule jk_module modules/mod_jk.so" >> /etc/httpd/conf/httpd.conf
	echo "JkWorkersFile conf/workers.properties" >> /etc/httpd/conf/httpd.conf
	echo "JkShmFile /tmp/shm" >> /etc/httpd/conf/httpd.conf
	echo "JkLogFile logs/mod_jk.log" >> /etc/httpd/conf/httpd.conf
	echo "JkLogLevel info" >> /etc/httpd/conf/httpd.conf
	echo "JkMount /test* lb" >> /etc/httpd/conf/httpd.conf
	systemctl stop firewalld
	systemctl enable httpd
	systemctl start httpd
	SHELL
   end
end
 


